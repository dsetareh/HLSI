<!DOCTYPE html>
<html lang="en-US">
<head>
  <title>HLSI Exercise - Path Loss</title>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width"/>
  <meta name="author" content=""/>
  <meta name="keywords" content=""/>
  <meta name="description" content=""/>
  <link rel="stylesheet" type="text/css" media="all" href="base.css">
</head>

<body>
  <h2>Exercise - Path Loss</h2>
  <p><a href="index.html">[exercises]</a></p>
  <p>
    <label for="distance">Distance = </label>
    <output for="distance" id="ds"></output>
  </p>
  <p>
    <label for="pathloss">Path Loss = </label>
    <output for="pathloss" id="pl"></output>
  </p>
</body>

<!-- Load in the javascript libraries -->
<script src="d3.v5.min.js"></script>
<script src="fft.js"></script>
<script src="support.js"></script>
<script>

// 2. Use the margin convention practice
var margin = {top: 50, right: 50, bottom: 50, left: 50}
  , width  = 920 - margin.left - margin.right  // Use the window's width
  , height = 320 - margin.top - margin.bottom; // Use the window's height

// options
var f0 = 1800e6;     // center frequency
var xrange=1200, yrange=600; // range in meters
var xmax  =1000, ymax  =500; // maximum values

// 2. Use the margin convention practice
var margin = {top: 50, right: 50, bottom: 50, left: 50}
  , width  = 920 - margin.left - margin.right  // Use the window's width
  , height = 640 - margin.top - margin.bottom; // Use the window's height

// scale
var xScale = d3.scaleLinear().domain([-xrange, xrange]).range([0, width]);
var yScale = d3.scaleLinear().domain([-yrange, yrange]).range([height, 0]);

// inverted scale
var xInvScale = d3.scaleLinear().range([-xrange, xrange]).domain([0, width]);
var yInvScale = d3.scaleLinear().range([-yrange, yrange]).domain([height, 0]);

// create SVG object and add labels
var svg = svg_create(margin, width, height, xScale, yScale);
svg_add_labels(svg, margin, width, height, "Horizonal Position (m)", "Vertical Position (m)");

// add pointer definition
var pointer = svg.append("defs").append("g")
        .attr("id","pointer")
        .attr("transform","scale(0.8)");
pointer.append("path").attr("d","M0-1c-14.5-25.6-14.5-25.7-14.5-33.8c0-8.1,6.5-14.6,14.5-14.6s14.5,6.6,14.5,14.6C14.5-26.7,14.5-26.6,0-1z");
pointer.append("path").attr("d","M0-49c7.7,0,14,6.3,14,14.1c0,8,0,8.1-14,32.8c-14-24.7-14-24.9-14-32.8C-14-42.7-7.7-49,0-49 M0-50c-8.3,0-15,6.8-15,15.1 S-15-26.5,0,0c15-26.5,15-26.5,15-34.9S8.3-50,0-50L0-50z");

// create markers with default positions
var markers = [
    {x:xScale(-xmax), y:yScale(ymax), c:"#039be5", b:"#004080"},
    {x:xScale(    0), y:yScale(   0), c:"#03e539", b:"#008040"},];

// d3's line generator
var line = d3.line()
    .x(function(d) { return d.x; })
    .y(function(d) { return d.y; });

// Append the path, bind the data, and call the line generator
var path = svg.append("path")
    .datum(markers)
    .attr("class", "stroke-light no-fill dashed stroke-gray-0")
    .attr("d", line);

// add markers with associated data
svg.selectAll("use")
    .data(markers)
    .enter()
    .append("use")
        .attr("href","#pointer")
        .attr("x",      function(d) { return (d.x) })
        .attr("y",      function(d) { return (d.y) })
        .attr("fill",   function(d) { return (d.c) })
        .attr("stroke", function(d) { return (d.b) })
        .attr("class","pin");

var dragHandler = d3.drag()
    .on("drag", function(d) {
        d3.select(this)
            .attr("x", d.x = Math.max(Math.min(d3.event.x,xScale(xmax)),xScale(-xmax)))
            .attr("y", d.y = Math.min(Math.max(d3.event.y,yScale(ymax)),yScale(-ymax))); // min/max flipped for y-axis
        update_display();
    });

dragHandler(svg.selectAll("use"));

// run initial update
update_display();

function update_pathloss() {
    // compute wavelength in meters
    let lambda = 299.792458e6 / f0;

    // compute distance and appropriate path loss
    let dx = xInvScale(markers[0].x) - xInvScale(markers[1].x);
    let dy = yInvScale(markers[0].y) - yInvScale(markers[1].y);
    let d  = Math.max(1,Math.sqrt(dx**2 + dy**2));
    let L  = 20*Math.log10(4*Math.PI*d/lambda);

    // update output numbers
    document.querySelector('#ds').value = d3.format(".3f")(d) + " m";
    document.querySelector('#pl').value = d3.format(".3f")(L) + " dB";
}

function update_display() {
    path.datum(markers).attr("d", line);
    update_pathloss();
}

</script>
</html>

